<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-CA" }}">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title>{{ page.title }} - {{ site.title }}</title>
    <link rel="stylesheet" href="{{ "assets/css/alt.css" | relative_url }}">
    <script type="text/javascript" src="/assets/js/randoText404.js"></script>
    <script type="text/javascript" src="/assets/js/BGM.js"></script>
    <script>
    function loadJSON(src) {
      return fetch(src).then(res => {
        if (!res.ok) throw new Error(`Failed to load ${src}`);
        return res.json();
      });
    }

    Promise.all([
      loadJSON('/assets/js/json/error.json')
    ]).then(([updates, lines]) => {
      window.updatesData = updates;
      window.linesData = lines;
      // Now load the rest of the scripts
      var scripts = [
        '/assets/js/randoText404.js',
      ];
      scripts.forEach(function(src) {
        var s = document.createElement('script');
        s.src = src;
        document.head.appendChild(s);
      });
    }).catch(err => {
      console.error('Error loading JSON:', err);
    });
  </script>
    <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="alternate" type="application/rss+xml" title="{{ site.title }}"
        href="{{ "/feed.xml" | relative_url }}" />
    {% include meta.html %}
</head>

<body>
    {% include gtag.html %}
    {% if page.title == "404" %}
    <audio id="BGM" loop>
        Your browser does not support the audio element.
    </audio>
    {% endif %}
    <div class="container">
        <div class="box">
            {% if page.title == "404" %}
            {{ content }}
            {% else %}
            <div class="page-header">
            <h1 class="page-title">{{ page.title }}</h1>
            </div>
            <br>
            {% include breadcrumbs.html %}
            <br>
            <script type="text/javascript" src="/assets/js/aspectRatio.js"></script>
            <script>
                let aspectRatioInfo = getAspectRatioInfo('{{ page.aspectRatio }}')
            </script>
            {% if page.flash == true %}
            <div class="fullscreen-center-wrapper" id="fullscreen-wrapper">
             <iframe id="game-iframe" srcdoc='
                <object width="100" height="100">
                <embed
                id="game-embed"
                src="src/game.swf"
                flashvars=""
                base="" 
                quality="high"
                allowscriptaccess="always"
                allowfullscreen="true"
                wmode="window"
                type="application/x-shockwave-flash" 
                pluginspage="http://www.macromedia.com/go/getflashplayer">
                </object>
            ' allowfullscreen ></iframe>
            </div>
            <button id="fullscreen-btn" style="margin-top:10px;">Fullscreen</button>
            <a href="src/game.swf" download class="btn btn-secondary">Download</a>
            {% else %}
             <div class="fullscreen-center-wrapper" id="fullscreen-wrapper">
             <iframe id="game-iframe" srcdoc='
                <object width="100" height="100">
                <embed
                id="game-embed"
                src="src/index.html"
                flashvars=""
                base="" 
                quality="high"
                allowscriptaccess="always"
                allowfullscreen="true"
                wmode="window"
                </object>
            ' allowfullscreen></iframe>
            </div>
            <button id="fullscreen-btn" style="margin-top:10px;">Fullscreen</button>
            {% endif %}
            {% endif %}
            <script>
            // Fallback loader: local -> remote mirror -> error message
            (function(){
              var is404 = ('{{ page.title | escape }}' === '404');
              if(is404) return;
              var isFlash = ('{{ page.flash | default: false | escape }}'.toLowerCase() === 'true');
              var pageUrl = '{{ page.url }}';
              if(pageUrl.slice(-1) !== '/') pageUrl += '/';
              var localResource = isFlash ? 'src/game.swf' : 'src/index.html';
              var remoteBase = 'https://mesaredux.mesagrey.ca';
              var remoteResource = remoteBase + pageUrl + localResource;
              var iframe = document.getElementById('game-iframe');
              var wrapper = document.getElementById('fullscreen-wrapper');
              if(!iframe || !wrapper) return;

              function showError(){
                wrapper.innerHTML = '<div class="game-load-error" style="padding:1em; text-align:center;">'
                  + '<h3 style="margin-top:0;">Game Failed To Load</h3>'
                  + '<p style="margin:0.5em 0;">We could not load this game locally or from the mirror.</p>'
                  + '<p style="margin:0.5em 0;">Please contact us on Discord via the <a href="/contact">contact page</a>.</p>'
                  + '<p style="font-size:0.85em; opacity:0.75;">If you use a script / content blocker, allow this site & the <a href="'+remoteBase+'">mirror domain.</a></p>'
                  + '</div>';
              }
              function applyFlash(remote){
                iframe.src = 'about:blank';
                iframe.removeAttribute('srcdoc');
                iframe.srcdoc = '<object width="100%" height="100%">\n'
                  + '<embed id="game-embed" src="'+remote+'" flashvars="" base="" quality="high" allowscriptaccess="always" allowfullscreen="true" wmode="window" type="application/x-shockwave-flash">'
                  + '</object>';
              }
              function applyHtml(remote){
                iframe.removeAttribute('srcdoc');
                iframe.src = remote.replace(/index\.html$/,'');
              }
              function updateDownload(){
                var dl = document.querySelector('a.btn.btn-secondary');
                if(!dl) return;
                if(isFlash){
                  dl.href = remoteResource;
                }
              }
              function loadRemote(){
                if(isFlash){
                  applyFlash(remoteResource);
                } else {
                  applyHtml(remoteResource);
                }
                updateDownload();
                // Verify remote actually reachable
                fetch(remoteResource, { method: 'HEAD' })
                  .then(r => { if(!r.ok) showError(); })
                  .catch(showError);
              }
              // Check local first
              fetch(localResource, { method: 'HEAD' }).then(function(res){
                if(!res.ok){
                  loadRemote();
                } else {
                  // Watchdog in case embedded local never populates
                  setTimeout(function(){
                    try {
                      var rect = iframe.getBoundingClientRect();
                      if(rect.width < 80 || rect.height < 80){ loadRemote(); }
                    } catch(e) {}
                  }, 1500);
                }
              }).catch(function(){ loadRemote(); });
              // Extra safety after 3s
              setTimeout(function(){
                try {
                  var rect = iframe.getBoundingClientRect();
                  if(rect.width < 50 || rect.height < 50){ loadRemote(); }
                } catch(e) {}
              }, 3000);
              // Final failure notice if still nothing after 6s (no content & still same srcdoc?)
              setTimeout(function(){
                try {
                  var rect = iframe.getBoundingClientRect();
                  if(rect.width < 50 || rect.height < 50){ showError(); }
                } catch(e) { showError(); }
              }, 6000);
            })();
            </script>
            <link rel="stylesheet" href="{{ "assets/css/gameWrapper.css" | relative_url }}">
            <script type="text/javascript" src="/assets/js/gameWrapper.js"></script>
        </div>
    </div>
      <div class="footer" role="contentinfo">
      <div class="inner" style="text-align:center; padding:0.5em 1em;">
  <p>&copy; {% assign thisyear = site.time | date: "%Y" %}{% if thisyear == "2025" %}2025{% else %}2025 - {{ thisyear }}{% endif %} Bored Entertainment. All rights reserved.</p>
      </div>
    </div>
    {% if page.title == "404" %}
    <div id="background" class="background"></div>
    <div id="background2" class="background"></div>
    {% endif %}

</body>
</html>